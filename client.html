<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" type="text/css" href="css/app.css">
  </head>
  <body id="body">
    <script src="/socket.io/socket.io.js"></script>
    <script>
      function statusChangeCallback(response) {
        if (response.status === 'connected') {
          getUserFromAPI();
        } else if (response.status === 'not_authorized') {
          document.getElementById('status').innerHTML = 'Please log ' +
            'into this app.';
        } else {
          document.getElementById('status').innerHTML = 'Please log ' +
            'into Facebook.';
        }
      }

      function checkLoginState() {
        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
      }

      var appId = '888594721196546';
      if (window.location.href.indexOf('localhost') > -1) {
        appId = '888596744529677';
      }

      window.fbAsyncInit = function() {
        FB.init({
          appId: appId,
          cookie: true,
          xfbml: true,
          version: 'v2.3'
        });

        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
      };

      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));

      var user, socketio;
      function getUserFromAPI() {
        document.getElementById('status').innerHTML = 'Fetching your information.... ';
        FB.api('/me', function(response) {
          user = response;

          document.getElementById('status').innerHTML = 'Fetching your information.... ';

          socketio = io.connect(location.href);

          socketio.on("message_to_client", function(data) {
            addMessage(data);
          });

          socketio.on("init_client", function(data) {
            var messages = data.messages || [];
            messages.map(addMessage);
          });

          document.getElementById('chat').style.display = 'inherit';
          document.getElementById('login').style.display = 'none';

          var msgElem = document.getElementById('message_input');
          msgElem.addEventListener('focusout', function(event) {
            if (msgElem.innerHTML) {
              var sendBtn = document.getElementById('send-button');
              sendBtn.style.display = 'inherit';
              sendBtn.scrollIntoView(true);
            }
          });

          msgElem.addEventListener('focusin', function(event) {
            document.getElementById('send-button').style.display = 'none';
            msgElem.scrollIntoView(true);
          })
        });
      }

      function addMessage(msg) {
        var chatlog = document.getElementById("chatlog"),
            li = document.createElement('li');
            // var = elemPos = document.getElementById('chatform');
        li.className = msg.userId === user.id ? 'you' : 'other';
        li.innerHTML = msg.username + ' ('+ msg.sentOn + '): ' + msg.message;
        chatlog.appendChild(li);
        // window.scrollTo(0, elemPos);
        document.getElementById('message_input').scrollIntoView(true);
        document.getElementById('message_input').focus();
      }

      function sendMessage(event) {
        event.preventDefault();
        var msgElem = document.getElementById("message_input");
        socketio.emit("message_to_server", { 
          message : msgElem.innerText, 
          sentOn: new Date(),
          username: user.name,
          userId: user.id 
        });
        msgElem.innerText = '';
      }

    </script>
    
    <div id="fb-root"></div>

    <div id="login" class="login">
      <h2>Welcome to Transient</h2>
      <p>Minimal social :)</p>
      <br>
      <fb:login-button scope="public_profile,email" size="xlarge" onlogin="checkLoginState();">
      </fb:login-button>
      <div id="status"></div>
    </div>

    <div id="chat" style="display: none;">
      <ul id="chatlog"></ul>
      <form id="chatform" action="">
        <div id="message_input" 
             class="input-wrapper" 
             contentEditable="true" 
             onkeypress="if (event.keyCode === 13) sendMessage(event)">
        </div>
        <div id="send-button" style="display: none;" class="button-wrapper">
          <button type="submit" onclick="sendMessage(event)">Send</button>
        </div>
      </form>
    </div>

  </body>
</html>