<!DOCTYPE html>
<html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <style>
        * { margin: 0; padding: 0; }
        body { 
          font: 14px Helvetica, Arial; 
          background-color: #EEE;
        }
        form {
          background-color: #EEE;
          width: 100%;
          position: fixed;
          top: 0;
          padding: 5px;
          border: 1px solid #DDD;
        }
        .input-wrapper textarea { 
          font: 14px Helvetica, Arial; 
          border-width: 0;
          padding: 0;
          margin: 0;
          width: 100%;
          outline: none;
        }
        .input-wrapper {
          background-color: #FFF;
          border: 1px solid #AAA;
          margin: 5px;
          padding: 10px;
          width: 90%;
          -moz-border-radius: 2px;
          -webkit-border-radius: 2px;
          -o-border-radius: 2px;
          -ms-border-radius: 2px;
          -khtml-border-radius: 2px;
          border-radius: 2px;
        }
        #chatlog {
          overflow: auto;
          margin-top: 60px;
          height: 90%;
          list-style-type: none; 
          padding: 3px; 
          background-color: #FFF;
        }
        #chatlog li { 
          position: relative;
          margin: 20px;
          -moz-border-radius: 4px;
          -webkit-border-radius: 4px;
          -o-border-radius: 4px;
          -ms-border-radius: 4px;
          -khtml-border-radius: 4px;
          padding: 5px 10px; 
          background: #eee; 
        }
        #chatlog li:after {
          content:"";
          position:absolute;
          bottom: -18px;
          left:30px;
          border:9px solid transparent;
          border-top-color:#eee;
          display: block;
          width:0;
        }
      </style>
    </head>
    <body id="body">
      <script src="/socket.io/socket.io.js"></script>
      <script>
        //FACEBOOK LOGIN
        function statusChangeCallback(response) {
          console.log('statusChangeCallback');
          console.log(response);
          if (response.status === 'connected') {
            testAPI();
          } else if (response.status === 'not_authorized') {
            document.getElementById('status').innerHTML = 'Please log ' +
              'into this app.';
          } else {
            document.getElementById('status').innerHTML = 'Please log ' +
              'into Facebook.';
          }
        }

        function checkLoginState() {
          FB.getLoginStatus(function(response) {
            statusChangeCallback(response);
          });
        }

        window.fbAsyncInit = function() {
          FB.init({
            appId: '888594721196546',
            cookie: true,
            xfbml: true,
            version: 'v2.3'
          });

          FB.getLoginStatus(function(response) {
            statusChangeCallback(response);
          });
        };

        (function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_US/sdk.js";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        function testAPI() {
          document.getElementById('status').innerHTML = 'Fetching your information.... ';
          FB.api('/me', function(response) {
            console.log('Successful login for: ' + response.name);
            document.getElementById('status').innerHTML =
              'Thanks for logging in, ' + response.name + '!';
          });
        }

        var socketio = io.connect(location.href);

        function addMessage(msg) {
          var chatlog = document.getElementById("chatlog");
          var li = document.createElement('li');
          li.innerHTML = msg.username + ' ('+ msg.sentOn + '): ' + msg.message;
          chatlog.appendChild(li);
          li.scrollIntoView(true);
          document.getElementById('message_input').focus();
        }

        socketio.on("message_to_client", function(data) {
          addMessage(data);
        });

        socketio.on("init_client", function(data) {
          var messages = data.messages || [];
          messages.map(addMessage);
        });

        function sendMessage(event) {
          if (!event || event.keyCode ===  13) {
            event.preventDefault();
            var msgElem = document.getElementById("message_input");
            socketio.emit("message_to_server", { 
              message : msgElem.value, 
              sentOn: new Date(),
              username: 'username' 
            });
            msgElem.value = '';
          }
        }

      </script>
      <div id="fb-root"></div>

      <fb:login-button scope="public_profile,email" size="xlarge" onlogin="checkLoginState();">
      </fb:login-button>

      <div id="status"></div>
      <ul id="chatlog"></ul>
      <input id="focushere" style="display:none" />
      <form id="chatform" action="">
        <div class="input-wrapper">
          <textarea placeholder="Enter message here and press enter ..." onkeypress="sendMessage(event)" id="message_input"></textarea>
        </div>
      </form>
    </body>
</html>